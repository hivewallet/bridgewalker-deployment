---
- hosts: bridgewalker
  user: jan
  gather_facts: no
  vars:
    home: /home/jan
  tasks:
  - name: install additional Ansible dependencies
    command: /usr/bin/aptitude -y install python-apt
                creates=/usr/share/doc/python-apt
    sudo: yes

  - name: install Debian packages
    apt: pkg=$item state=present
    with_items:
      - screen
      - htop
      - openjdk-6-jre-headless       # MtGoxCachingProxy seems to have
                                     # problems with Java 7
      - supervisor
      - postgresql
      - python-psycopg2
      - haskell-platform
    sudo: yes

  - name: install Haskell development packages
    apt: pkg=$item state=present
    with_items:
      - libghc-aeson-dev
      - libghc-attoparsec-dev
      - libghc-base16-bytestring-dev
      - libghc-base64-bytestring-dev
      - libghc-cereal-dev
      - libghc-configfile-dev
      - libghc-curl-dev
      - libghc-hashable-dev
      - libghc-http-dev
      - libghc-ixset-dev
      - libghc-monadcatchio-transformers-dev
      - libghc-mtl-dev
      - libghc-network-dev
      - libghc-postgresql-simple-dev
      - libghc-pwstore-fast-dev
      - libghc-random-dev
      - libghc-regex-compat-dev
      - libghc-sha-dev
      - libghc-text-dev
      - libghc-transformers-dev
      - libghc-unordered-containers-dev
      - libghc-vector-dev
    sudo: yes
    when_set: $is_staging

#  - name: install additional Haskell development packages via Cabal
#    shell: #cabal update;
#           cd /home/jan/src/watchdog; cabal install;
#           cd /home/jan/src/bitcoin-rpc2; cabal install;
#           cd /home/jan/src/mtgoxapi; cabal install;
#           cd /home/jan/src/metricsd-client; cabal install;
#           cd /home/jan/src/bridgewalker; cabal install;
#    when_set: $is_staging

  - name: create link to Bridgewalker source code
    file: src=$home/src/bridgewalker
          dest=$home/bridgewalker
          state=link
    when_set: $is_staging

  - name: create folders for MtGoxCachingProxy
    file: path=$home/$item
          state=directory
    with_items:
      - MtGoxCachingProxy
      - MtGoxCachingProxy/lib

  - name: install MtGoxCachingProxy
    copy: src=../MtGoxCachingProxy/dist/$item
          dest=$home/MtGoxCachingProxy/$item
    with_items:
      - MtGoxCachingProxy.jar
      - lib/socketio.jar
    notify: restart mtgoxcachingproxy

  - name: add supervisor configuration for MtGoxCachingProxy
    copy: src=files/etc/supervisor/conf.d/mtgoxcachingproxy.conf
          dest=/etc/supervisor/conf.d/mtgoxcachingproxy.conf
          owner=root
          group=root
    sudo: yes
    notify: update supervisor

  - name: create Bitcoin daemon configuration directory
    file: path=$home/.bitcoin
          state=directory

  - name: install pidnotifier
    copy: src=../../one-off/PidNotifier/PidNotifier
          dest=$home/.bitcoin/pidnotifier

  - name: add Debian backports repository
    copy: src=files/etc/apt/sources.list.d/backports.list
          dest=/etc/apt/sources.list.d/backports.list
          owner=root
          group=root
          mode=644
    sudo: yes
    notify: update aptitude

  - name: install backported nginx  # need at least 1.3.13 for websocket support
    apt: pkg=nginx default_release=wheezy-backports state=present
    sudo: yes

  - name: create database for Bridgewalker
    postgresql_db: name=bridgewalker
    sudo_user: postgres
    sudo: yes

  - name: give user jan access to database
    shell: /usr/bin/createuser --no-createdb --no-createrole --no-superuser jan;
           touch /var/lib/postgresql/.ansible_marker_user_jan_created
           creates=/var/lib/postgresql/.ansible_marker_user_jan_created
    sudo_user: postgres
    sudo: yes

  handlers:
  - name: update supervisor
    command: /usr/bin/supervisorctl update
    sudo: yes

  - name: restart mtgoxcachingproxy
    command: /usr/bin/supervisorctl restart mtgoxcachingproxy
    sudo: yes

  - name: update aptitude
    command: /usr/bin/aptitude update
    sudo: yes
